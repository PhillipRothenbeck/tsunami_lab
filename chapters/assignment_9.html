<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10. Weekly Report 9 &mdash; Tsunami Lab  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11. individual Phase - Intermediate Report" href="assignment_10.html" />
    <link rel="prev" title="9. Weekly Report 8" href="assignment_8.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Tsunami Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user_documentation.html">1. User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_1.html">2. Report Week 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_2.html">3. Report Week 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_3.html">4. Week Report 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_4.html">5. Week Report 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_5.html">6. Week Report 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_6.html">7. Week Report 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_7.html">8. Week Report 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_8.html">9. Weekly Report 8</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. Weekly Report 9</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#parallelization">10.1. Parallelization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#parallelization-in-simulator">10.1.1. parallelization in Simulator:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parallelization-in-netcdf">10.1.2. parallelization in NetCDF:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parallelization-of-wavepropagation2d">10.1.3. parallelization of Wavepropagation2d:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="assignment_10.html">11. individual Phase - Intermediate Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_11.html">12. Individual Phase - Final Report</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Tsunami Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">10. </span>Weekly Report 9</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/chapters/assignment_9.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="weekly-report-9">
<span id="ch-task-9"></span><h1><span class="section-number">10. </span>Weekly Report 9<a class="headerlink" href="#weekly-report-9" title="Link to this heading"></a></h1>
<section id="parallelization">
<h2><span class="section-number">10.1. </span>Parallelization<a class="headerlink" href="#parallelization" title="Link to this heading"></a></h2>
<p>For parallelization, we concentrated on Simulator.cpp (solver setup), NetCDF.cpp (coarse Output) and Wavepropagation2d (timeStep).</p>
<p>All tests were performed with a grid size of 10000m and a coarse-factor of 50m.</p>
<p>chile_10000mCoarse.json config file:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;dimension&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;nx&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">350</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;ny&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">295</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;xLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3500000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;yLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2950000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;bathymetryFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_bath_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;displacementsFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_displ_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetX&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-3000000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetY&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-1450000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;simTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">44300</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;boundaryCond&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;OO&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;setup&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;TsunamiEvent&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;coarseFactor&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">50</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Enabled OpenMP support for GNU and Intel compilers in Sconstruct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set optimization mode</span>
<span class="k">if</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]:</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-O0&#39;</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="k">if</span> <span class="s1">&#39;g++&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-O2&#39;</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;icpc&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-fast&#39;</span> <span class="p">]</span> <span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;g++&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-fopenmp&#39;</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">LINKFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-fopenmp&#39;</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;icpc&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-qopenmp&#39;</span> <span class="p">]</span> <span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">LINKFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-qopenmp&#39;</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<section id="parallelization-in-simulator">
<h3><span class="section-number">10.1.1. </span>parallelization in Simulator:<a class="headerlink" href="#parallelization-in-simulator" title="Link to this heading"></a></h3>
<p>code before parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// set up solver</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_ny</span><span class="p">;</span><span class="w"> </span><span class="n">l_cy</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="w"> </span><span class="n">l_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_dy</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_nx</span><span class="p">;</span><span class="w"> </span><span class="n">l_cx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="w"> </span><span class="n">l_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_dx</span><span class="p">;</span>
</pre></div>
</div>
<p>code after parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// set up solver</span>
<span class="cp">#pragma omp parallel for collapse(2) schedule(static, 8) reduction(max : l_hMax)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_ny</span><span class="p">;</span><span class="w"> </span><span class="n">l_cy</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">l_nx</span><span class="p">;</span><span class="w"> </span><span class="n">l_cx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="w"> </span><span class="n">l_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_cy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_dy</span><span class="p">;</span>
<span class="w">            </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="w"> </span><span class="n">l_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_cx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_dx</span><span class="p">;</span>
</pre></div>
</div>
<p>Speedup <span class="math notranslate nohighlight">\(S_p\)</span> with <span class="math notranslate nohighlight">\(T_1 = 2078.36s\)</span> and <span class="math notranslate nohighlight">\(T_p = 37.2162s\)</span> for <span class="math notranslate nohighlight">\(p = 72\)</span> cores:</p>
<div class="math notranslate nohighlight">
\[\begin{split}S_p &amp;= \frac{T_1}{T_p} \\
S_{72} &amp;= \frac{2078.36s}{37.2162s} = 55.845\end{split}\]</div>
</section>
<section id="parallelization-in-netcdf">
<h3><span class="section-number">10.1.2. </span>parallelization in NetCDF:<a class="headerlink" href="#parallelization-in-netcdf" title="Link to this heading"></a></h3>
<p>code before parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// coarse output</span>
<span class="w">    </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxCoarse</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nx</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">l_dataX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataX</span><span class="p">[</span><span class="n">l_ix</span><span class="p">];</span>
<span class="w">        </span><span class="n">l_idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varXId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataX</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataX</span><span class="p">;</span>

<span class="w">    </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nyCoarse</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_ny</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">l_dataY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataY</span><span class="p">[</span><span class="n">l_iy</span><span class="p">];</span>
<span class="w">        </span><span class="n">l_idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varYId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataY</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataY</span><span class="p">;</span>

<span class="w">    </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_ny</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nx</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// average over neighbors</span>
<span class="w">            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataB</span><span class="p">[</span><span class="n">l_iy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_ix</span><span class="p">];</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetX</span><span class="p">;</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetY</span><span class="p">;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">NetCDF</span><span class="o">::</span><span class="n">isInBounds</span><span class="p">(</span><span class="n">l_idxX</span><span class="p">,</span><span class="w"> </span><span class="n">l_idxY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_dataB</span><span class="p">[</span><span class="n">l_idxY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_idxX</span><span class="p">];</span>
<span class="w">                            </span><span class="n">l_neighborCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">            </span><span class="n">l_idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varBathymetryId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataB</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataB</span><span class="p">;</span>

<span class="w">    </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_momentumX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="w">    </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_momentumY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_frame</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">;</span><span class="w"> </span><span class="n">l_frame</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_ny</span><span class="p">;</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nx</span><span class="p">;</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// average over neighbors</span>
<span class="w">                </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_framedIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_iy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_ix</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_nxy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_frame</span><span class="p">;</span>
<span class="w">                </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_height</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">                </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_momentumX</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">                </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_momentumY</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">                </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetX</span><span class="p">;</span>
<span class="w">                            </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetY</span><span class="p">;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">NetCDF</span><span class="o">::</span><span class="n">isInBounds</span><span class="p">(</span><span class="n">l_idxX</span><span class="p">,</span><span class="w"> </span><span class="n">l_idxY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_framedIdxOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_idxY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_idxX</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_nxy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_frame</span><span class="p">;</span>
<span class="w">                                </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_height</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                                </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_momentumX</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                                </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_momentumY</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                                </span><span class="n">l_neighborCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">                </span><span class="n">l_idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varHeightId</span><span class="p">,</span><span class="w"> </span><span class="n">l_height</span><span class="p">);</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varMomentumXId</span><span class="p">,</span><span class="w"> </span><span class="n">l_momentumX</span><span class="p">);</span>
<span class="w">    </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varMomentumYId</span><span class="p">,</span><span class="w"> </span><span class="n">l_momentumY</span><span class="p">);</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_height</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_momentumX</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_momentumY</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>code after parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// coarse output</span>
<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxCoarse</span><span class="p">];</span>
<span class="cp">#pragma omp parallel for schedule(static, 16)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nxCoarse</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_dataX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataX</span><span class="p">[</span><span class="n">l_ix</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varXId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataX</span><span class="p">);</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataX</span><span class="p">;</span>

<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nyCoarse</span><span class="p">];</span>
<span class="cp">#pragma omp parallel for schedule(static, 16)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nyCoarse</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_dataY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataY</span><span class="p">[</span><span class="n">l_iy</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varYId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataY</span><span class="p">);</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataY</span><span class="p">;</span>

<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_dataB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="p">];</span>
<span class="cp">#pragma omp parallel for schedule(static, 8)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nxyCoarse</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">m_nxCoarse</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m_nxCoarse</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// average over neighbors</span>
<span class="w">            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_dataB</span><span class="p">[</span><span class="n">l_iy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_ix</span><span class="p">];</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetX</span><span class="p">;</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetY</span><span class="p">;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">NetCDF</span><span class="o">::</span><span class="n">isInBounds</span><span class="p">(</span><span class="n">l_idxX</span><span class="p">,</span><span class="w"> </span><span class="n">l_idxY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_dataB</span><span class="p">[</span><span class="n">l_idxY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_idxX</span><span class="p">];</span>
<span class="w">                            </span><span class="n">l_neighborCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">l_dataB</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varBathymetryId</span><span class="p">,</span><span class="w"> </span><span class="n">l_dataB</span><span class="p">);</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_dataB</span><span class="p">;</span>

<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_momentumX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="w">        </span><span class="n">t_real</span><span class="w"> </span><span class="o">*</span><span class="n">l_momentumY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">t_real</span><span class="p">[</span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">];</span>
<span class="cp">#pragma omp parallel for schedule(static, 16)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nxyCoarse</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_frameCount</span><span class="p">;</span><span class="w"> </span><span class="n">l_idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// average over neighbors</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m_nxyCoarse</span><span class="p">);</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">l_idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">m_nxCoarse</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">floor</span><span class="p">((</span><span class="n">l_idx</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">m_nxyCoarse</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">m_nxCoarse</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_framedIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_iy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_ix</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_nxy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_frame</span><span class="p">;</span>
<span class="w">            </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_height</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_momentumX</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_momentumY</span><span class="p">[</span><span class="n">l_framedIdx</span><span class="p">];</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">m_coarseFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="n">l_offsetX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">m_coarseFactor</span><span class="p">;</span><span class="w"> </span><span class="n">l_offsetX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_ix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetX</span><span class="p">;</span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">l_idxY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_iy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_offsetY</span><span class="p">;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tsunami_lab</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">NetCDF</span><span class="o">::</span><span class="n">isInBounds</span><span class="p">(</span><span class="n">l_idxX</span><span class="p">,</span><span class="w"> </span><span class="n">l_idxY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_framedIdxOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">l_idxY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">m_nx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">l_idxX</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_nxy</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_frame</span><span class="p">;</span>
<span class="w">                            </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_height</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                            </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_momentumX</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                            </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_momentumY</span><span class="p">[</span><span class="n">l_framedIdxOffset</span><span class="p">];</span>
<span class="w">                            </span><span class="n">l_neighborCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">l_height</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">            </span><span class="n">l_momentumX</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">            </span><span class="n">l_momentumY</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">l_neighborCount</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varHeightId</span><span class="p">,</span><span class="w"> </span><span class="n">l_height</span><span class="p">);</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varMomentumXId</span><span class="p">,</span><span class="w"> </span><span class="n">l_momentumX</span><span class="p">);</span>
<span class="w">        </span><span class="n">l_nc_err</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">nc_put_var_float</span><span class="p">(</span><span class="n">m_ncId</span><span class="p">,</span><span class="w"> </span><span class="n">m_varMomentumYId</span><span class="p">,</span><span class="w"> </span><span class="n">l_momentumY</span><span class="p">);</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_height</span><span class="p">;</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_momentumX</span><span class="p">;</span>
<span class="w">        </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_momentumY</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>Speedup <span class="math notranslate nohighlight">\(S_p\)</span> with <span class="math notranslate nohighlight">\(T_1 = 11.0647s\)</span> and <span class="math notranslate nohighlight">\(T_p = 4.14647s\)</span> for <span class="math notranslate nohighlight">\(p = 72\)</span> cores:</p>
<div class="math notranslate nohighlight">
\[\begin{split}S_p &amp;= \frac{T_1}{T_p} \\
S_{72} &amp;= \frac{11.0647s}{4.14647s} = 2.668\end{split}\]</div>
</section>
<section id="parallelization-of-wavepropagation2d">
<h3><span class="section-number">10.1.3. </span>parallelization of Wavepropagation2d:<a class="headerlink" href="#parallelization-of-wavepropagation2d" title="Link to this heading"></a></h3>
<p>coder before parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1">// init cell (Star) quantities</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_ceX</span><span class="p">,</span><span class="w"> </span><span class="n">l_ceY</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hvOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// iterate over edges in x-direction for every row and update with Riemann solutions (x-sweep)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// determine left and right cell-id</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// compute net-updates</span>
<span class="w">            </span><span class="n">t_real</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

<span class="w">            </span><span class="n">solvers</span><span class="o">::</span><span class="n">FWave</span><span class="o">::</span><span class="n">netUpdates</span><span class="p">(</span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// update the cells&#39; quantities</span>
<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// init new cell quantities</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_ceX</span><span class="p">,</span><span class="w"> </span><span class="n">l_ceY</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// iterate over edges in y-direction for every column and update with Riemann solutions (y-sweep)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// determine upper and lower cell-id</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// compute net-updates</span>
<span class="w">            </span><span class="n">t_real</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

<span class="w">            </span><span class="n">solvers</span><span class="o">::</span><span class="n">FWave</span><span class="o">::</span><span class="n">netUpdates</span><span class="p">(</span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// update the cells&#39; quantities</span>
<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_hStar</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_huStar</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_hvStar</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>code after parallelization:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// init cell (Star) quantities</span>
<span class="cp">#pragma omp parallel for collapse(2) schedule(static, 32)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_ceX</span><span class="p">,</span><span class="w"> </span><span class="n">l_ceY</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hvOld</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// iterate over edges in x-direction for every row and update with Riemann solutions (x-sweep)</span>
<span class="cp">#pragma omp parallel for collapse(2) shared(l_hStar, l_huStar)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// determine left and right cell-id</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// compute net-updates</span>
<span class="w">            </span><span class="n">t_real</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

<span class="w">            </span><span class="n">solvers</span><span class="o">::</span><span class="n">FWave</span><span class="o">::</span><span class="n">netUpdates</span><span class="p">(</span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hOld</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_huOld</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// update the cells&#39; quantities</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_ceL</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_ceR</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingX</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// init new cell quantities</span>
<span class="cp">#pragma omp parallel for collapse(2) schedule(static, 32)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_ceX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_ceX</span><span class="p">,</span><span class="w"> </span><span class="n">l_ceY</span><span class="p">);</span>
<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_huNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_huStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_idx</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// iterate over edges in y-direction for every column and update with Riemann solutions (y-sweep)</span>
<span class="cp">#pragma omp parallel for collapse(2) shared(l_hNew, l_hvNew)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edX</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_nCellsY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">l_edY</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// determine upper and lower cell-id</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="p">);</span>
<span class="w">            </span><span class="n">t_idx</span><span class="w"> </span><span class="n">l_ceD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getIndex</span><span class="p">(</span><span class="n">l_edX</span><span class="p">,</span><span class="w"> </span><span class="n">l_edY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// compute net-updates</span>
<span class="w">            </span><span class="n">t_real</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>

<span class="w">            </span><span class="n">solvers</span><span class="o">::</span><span class="n">FWave</span><span class="o">::</span><span class="n">netUpdates</span><span class="p">(</span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hStar</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_hvStar</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">m_b</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="w">                                    </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// update the cells&#39; quantities</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_ceU</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hNew</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#pragma omp atomic update</span>
<span class="w">            </span><span class="n">l_hvNew</span><span class="p">[</span><span class="n">l_ceD</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">i_scalingY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">l_netUpdates</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_hStar</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_huStar</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">l_hvStar</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Speedup <span class="math notranslate nohighlight">\(S_p\)</span> with <span class="math notranslate nohighlight">\(T_1 = 1886.31s\)</span> and <span class="math notranslate nohighlight">\(T_p = 342.513s\)</span> for <span class="math notranslate nohighlight">\(p = 72\)</span> cores:</p>
<div class="math notranslate nohighlight">
\[\begin{split}S_p &amp;= \frac{T_1}{T_p} \\
S_{72} &amp;= \frac{1886.31s}{342.513s} = 5.5072\end{split}\]</div>
<p>In summary, parallelizing the two-dimensional wave propagation initialization in <code class="code docutils literal notranslate"><span class="pre">Simulator.cpp</span></code> resulted in a speedup of 55.8, while parallelizing the coarse output in <code class="code docutils literal notranslate"><span class="pre">NetCDF.cpp</span></code> resulted in a speedup of 2.6
and parallelizing the netUpdates in <code class="code docutils literal notranslate"><span class="pre">Wavepropagation2d.cpp</span></code> resulted in a speedup of 5.5.</p>
<p>After parallelizing everything, we ran InteVTune again with the following result:</p>
<a class="reference internal image-reference" href="../_images/hotspots.png"><img alt="../_images/hotspots.png" src="../_images/hotspots.png" style="width: 400px;" /></a>
<p>Hotspots</p>
<a class="reference internal image-reference" href="../_images/histogramm.png"><img alt="../_images/histogramm.png" src="../_images/histogramm.png" style="width: 400px;" /></a>
<p>It can make sense to spawn more threads than cores if the distributed workload of the cores is unbalanced.</p>
<div class="line-block">
<div class="line">It is better to parallelize the outer loop than the inner loop. In our case, it is about 1.9 times faster. (Since it was tested on a system with a lower core count than ARA, the actual factor is likely to be much higher.)</div>
<div class="line">OpenMP’s parallelization is executed n times in the inner for-loop, where n is the length of the outer for-loop, but only once in the outer loop. OpenMP must therefore ensure that the workload is balanced and distributed across the cores n-1 times more frequently in the case of the inner loop. This results in many more threads, which increases the thread management costs.</div>
</div>
<p>We have tried different scheduling variants and stuck with one that worked best for us. (We decided on the fastest scheduling for each individual pragma.)
Pinning, on the other hand, didn’t make much of a difference to us, which is why we didn’t give it any further attention.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="assignment_8.html" class="btn btn-neutral float-left" title="9. Weekly Report 8" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="assignment_10.html" class="btn btn-neutral float-right" title="11. individual Phase - Intermediate Report" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Bohdan Babii, Phillip Rothenbeck, Moritz Rätz, Marek Sommerfeld.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>