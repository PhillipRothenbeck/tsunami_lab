<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9. Weekly Report 8 &mdash; Tsunami Lab  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10. Weekly Report 9" href="assignment_9.html" />
    <link rel="prev" title="8. Week Report 7" href="assignment_7.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Tsunami Lab
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user_documentation.html">1. User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_1.html">2. Report Week 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_2.html">3. Report Week 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_3.html">4. Week Report 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_4.html">5. Week Report 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_5.html">6. Week Report 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_6.html">7. Week Report 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_7.html">8. Week Report 7</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9. Weekly Report 8</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#migration-to-ara">9.1. Migration to ARA</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comparison-of-ara-vs-home-system">9.1.1. Comparison of ARA vs. home system</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interchangeability-of-compilers">9.2. Interchangeability of compilers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comparison-of-different-optimization-switches">9.2.1. Comparison of different optimization switches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimization-report">9.2.2. Optimization Report</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#instrumentation-and-perfmance-counters">9.3. Instrumentation and Perfmance Counters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#individual-phase">9.4. Individual Phase</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="assignment_9.html">10. Weekly Report 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_10.html">11. individual Phase - Intermediate Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="assignment_11.html">12. Individual Phase - Final Report</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Tsunami Lab</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">9. </span>Weekly Report 8</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/chapters/assignment_8.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="weekly-report-8">
<span id="ch-task-8"></span><h1><span class="section-number">9. </span>Weekly Report 8<a class="headerlink" href="#weekly-report-8" title="Link to this heading"></a></h1>
<section id="migration-to-ara">
<h2><span class="section-number">9.1. </span>Migration to ARA<a class="headerlink" href="#migration-to-ara" title="Link to this heading"></a></h2>
<p>The migration from LeChuck to the ARA cluster went without any major problems.</p>
<p>The following batch script was used to simulate the 2010 tsunami in Chile (and thus prove the functionality of the solver):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#!/bin/bash</span>
<span class="cp">#SBATCH --job-name=tsunami</span>
<span class="cp">#SBATCH --output=tsunami.out</span>
<span class="cp">#SBATCH --error=tsunami.err</span>
<span class="cp">#SBATCH --partition=s_hadoop</span>
<span class="cp">#SBATCH --nodes=1</span>
<span class="cp">#SBATCH --ntasks=1</span>
<span class="cp">#SBATCH --time=10:00:00</span>
<span class="cp">#SBATCH --cpus-per-task=72</span>

<span class="cp"># Load modules</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">tools</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="mf">3.8</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">compiler</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">11.2.0</span>
<span class="n">python3</span><span class="mf">.8</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">scons</span>

<span class="n">date</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">beegfs</span><span class="o">/</span><span class="n">ri26lit</span><span class="o">/</span><span class="n">tsunami_lab</span>
<span class="n">scons</span>
<span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">tsunami_lab</span><span class="w"> </span><span class="n">chile_10000m</span><span class="p">.</span><span class="n">json</span>
</pre></div>
</div>
<p>with the corresponding config file chile_10000m.json:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;dimension&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;nx&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">350</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;ny&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">295</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;xLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3500000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;yLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2950000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;bathymetryFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_bath_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;displacementsFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_displ_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetX&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-3000000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetY&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-1450000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;simTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">44300</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;boundaryCond&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;OO&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;setup&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;TsunamiEvent&quot;</span>
<span class="w">    </span><span class="s">&quot;checkPoints&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The visualization of the 2010 chile tsunami event seems to work as intended:</p>
<video autoplay="True" controls="True" height="300" loop="True" preload="auto" width="650"><source src="../_static/assignment_8/chile_10000m.mp4" type="video/mp4"></video><section id="comparison-of-ara-vs-home-system">
<h3><span class="section-number">9.1.1. </span>Comparison of ARA vs. home system<a class="headerlink" href="#comparison-of-ara-vs-home-system" title="Link to this heading"></a></h3>
<p>To show the difference in calculation time between the ara cluster and our own system, the chile tsunami event was simulated with a grid size of 10000m.</p>
<p>We decided not to use the time per cell and iteration, but the time of the entire simulation (file I/O and setup time excluded).</p>
<p>home system: <span class="math notranslate nohighlight">\(\text{AMD Ryzen}^ \text{TM}\)</span> 7 4700U &#64; 2.00GHz (RAM: 24.00GB &#64; 3200MHz)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span> <span class="n">time</span> <span class="o">/</span> <span class="c1">#time steps / #step: 43439 / 2450 / 98</span>
<span class="n">simulation</span> <span class="n">time</span> <span class="o">/</span> <span class="c1">#time steps / #step: 43882.2 / 2475 / 99</span>
<span class="n">Simulation</span> <span class="n">Took</span><span class="p">:</span> <span class="mf">18.9094</span><span class="n">s</span>
<span class="o">./</span><span class="n">out</span><span class="o">/</span><span class="n">chile_10000m</span><span class="o">.</span><span class="n">nc</span>
<span class="n">finished</span> <span class="n">time</span> <span class="n">loop</span>
<span class="n">freeing</span> <span class="n">memory</span>
<span class="n">finished</span><span class="p">,</span> <span class="n">exiting</span>
</pre></div>
</div>
<p>ARA-Cluster: <span class="math notranslate nohighlight">\(\text{Skylake Intel}^ \text{®}\)</span> <span class="math notranslate nohighlight">\(\text{Xeon}^ \text{®}\)</span> Gold 6140 &#64; 2.30GHz (RAM: 192GB)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">simulation</span> <span class="n">time</span> <span class="o">/</span> <span class="c1">#time steps / #step: 43439 / 2450 / 98</span>
<span class="n">simulation</span> <span class="n">time</span> <span class="o">/</span> <span class="c1">#time steps / #step: 43882.2 / 2475 / 99</span>
<span class="n">Simulation</span> <span class="n">Took</span><span class="p">:</span> <span class="mf">13.1988</span><span class="n">s</span>
<span class="o">./</span><span class="n">out</span><span class="o">/</span><span class="n">chile_10000m</span><span class="o">.</span><span class="n">nc</span>
<span class="n">finished</span> <span class="n">time</span> <span class="n">loop</span>
<span class="n">freeing</span> <span class="n">memory</span>
<span class="n">finished</span><span class="p">,</span> <span class="n">exiting</span>
</pre></div>
</div>
<p>As expected (since the hardware on ARA is better), the ARA cluster seems to be roughly 43% faster than our home system.
That’s not a huge difference, especially when you consider that our home system is a five year old laptop.</p>
</section>
</section>
<section id="interchangeability-of-compilers">
<h2><span class="section-number">9.2. </span>Interchangeability of compilers<a class="headerlink" href="#interchangeability-of-compilers" title="Link to this heading"></a></h2>
<p>Implemented compiler interchangeability in sconstruct by adding a new variable <code class="code docutils literal notranslate"><span class="pre">CXX</span></code> with default value <code class="code docutils literal notranslate"><span class="pre">g++</span></code>. The Compiler can be set just like the mode with <code class="code docutils literal notranslate"><span class="pre">scons</span> <span class="pre">CXX=icpc</span></code>.
In addition, the environment <code class="code docutils literal notranslate"><span class="pre">env</span></code> has been extended by the addition of <code class="code docutils literal notranslate"><span class="pre">ENV=os.environ</span></code>.
The default flag for <code class="code docutils literal notranslate"><span class="pre">g++</span></code> and <code class="code docutils literal notranslate"><span class="pre">icpc</span></code> is <code class="code docutils literal notranslate"><span class="pre">-O2</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="o">.</span><span class="n">AddVariables</span><span class="p">(</span>
  <span class="n">EnumVariable</span><span class="p">(</span> <span class="s1">&#39;CXX&#39;</span><span class="p">,</span>
                <span class="s1">&#39;compiler options: g++, icpc&#39;</span><span class="p">,</span>
                <span class="s1">&#39;g++&#39;</span><span class="p">,</span>
                <span class="n">allowed_values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;g++&#39;</span><span class="p">,</span> <span class="s1">&#39;icpc&#39;</span><span class="p">)</span>
              <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ...</span>

<span class="c1"># create environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span> <span class="n">ENV</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="nb">vars</span> <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use the </span><span class="si">{</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> compiler&quot;</span><span class="p">)</span>

<span class="c1"># ...</span>

<span class="c1"># set optimization mode</span>
<span class="k">if</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]:</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-O0&#39;</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<span class="k">if</span> <span class="s1">&#39;g++&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-O2&#39;</span> <span class="p">]</span> <span class="p">)</span>
<span class="k">elif</span> <span class="s1">&#39;icpc&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]:</span>
    <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-O2&#39;</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<p>If you compare the time required by both compilers, the g++ compiler is faster than icpc, but the code itself runs faster if it is generated with icpc.</p>
<section id="comparison-of-different-optimization-switches">
<h3><span class="section-number">9.2.1. </span>Comparison of different optimization switches<a class="headerlink" href="#comparison-of-different-optimization-switches" title="Link to this heading"></a></h3>
<p>The comparison of the two compilers was conducted by the tsunami event in Chile with a grid size of 10000m.</p>
<p>corresponding chile_10000m.json config file:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;dimension&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;nx&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">350</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;ny&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">295</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;xLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3500000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;yLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2950000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;bathymetryFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_bath_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;displacementsFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_displ_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetX&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-3000000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetY&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-1450000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;simTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">44300</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;boundaryCond&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;OO&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;setup&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;TsunamiEvent&quot;</span>
<span class="w">    </span><span class="s">&quot;checkPoints&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We used the time that the simulation took (in seconds), excluding file I/O and setup time.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Configuration</p></th>
<th class="head"><p>g++</p></th>
<th class="head"><p>icpc</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>O2</p></td>
<td><p>13.1988s</p></td>
<td><p>12.6979s</p></td>
</tr>
<tr class="row-odd"><td><p>Ofast</p></td>
<td><p>11.1114s</p></td>
<td><p>13.11s</p></td>
</tr>
<tr class="row-even"><td><p>fast</p></td>
<td></td>
<td><p>10.9384s</p></td>
</tr>
</tbody>
</table>
<p>In direct comparison with the O2 flag, the icpc compiler generated slightly faster code.
Unexpectedly, with the ofast flag, the g++ compiler generated faster code compared to the icpc compiler.
Since only the icpc compiler could be executed with the fast flag, we have no comparison with the g++ compiler.
It could be assumed that the g++ compiler would have become even faster, since ‘fast’ is a combination of ‘Ofast’, ‘ipo’, ‘static’ and ‘xHost’.</p>
<p>Based on these results, we decided not to set our default flag for <code class="code docutils literal notranslate"><span class="pre">g++</span></code> to <code class="code docutils literal notranslate"><span class="pre">-Ofast</span></code> since it contains the <code class="code docutils literal notranslate"><span class="pre">O3</span></code> flag,
which is recommended when working with loops involving intensive floating point calculations but generates unstable code.
The default flag for <code class="code docutils literal notranslate"><span class="pre">icpc</span></code> was set to <code class="code docutils literal notranslate"><span class="pre">fast</span></code>.</p>
</section>
<section id="optimization-report">
<h3><span class="section-number">9.2.2. </span>Optimization Report<a class="headerlink" href="#optimization-report" title="Link to this heading"></a></h3>
<p>Added an option for compiler optimization reports in Sconstruct.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">vars</span><span class="o">.</span><span class="n">AddVariables</span><span class="p">(</span>
  <span class="n">EnumVariable</span><span class="p">(</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span>
                <span class="s1">&#39;options: 0 to 5&#39;</span><span class="p">,</span>
                <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                <span class="n">allowed_values</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
              <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># ...</span>

<span class="k">if</span> <span class="s1">&#39;icpc&#39;</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;CXX&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]:</span>
  <span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span> <span class="n">CXXFLAGS</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;-qopt-report=&#39;</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<p>According to the report, the Roe-solver can be inlined, but not the FWave-solver or Wavepropagation2d, as this would exceed the <code class="code docutils literal notranslate"><span class="pre">-inline-max-size</span></code> value.
Furthermore, the compiler is not able to vectorize our loops (getbathymetry and getheight) because there are too many vector dependencies.</p>
</section>
</section>
<section id="instrumentation-and-perfmance-counters">
<h2><span class="section-number">9.3. </span>Instrumentation and Perfmance Counters<a class="headerlink" href="#instrumentation-and-perfmance-counters" title="Link to this heading"></a></h2>
<p>To gain additional insight into our code and its optimization, we used Intel Vtune Profile.
Once again, the tsunami simulation of Chile with a grid size of 10000m was used.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;dimension&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;nx&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">350</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;ny&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">295</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;xLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3500000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;yLen&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2950000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;bathymetryFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_bath_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;displacementsFileName&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;chile_gebco20_usgs_250m_displ_fixed.nc&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetX&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-3000000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;epicenterOffsetY&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">-1450000.0</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;simTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">44300</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;boundaryCond&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;OO&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;setup&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;TsunamiEvent&quot;</span>
<span class="w">    </span><span class="s">&quot;checkPoints&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
<p>First, we looked into the <code class="code docutils literal notranslate"><span class="pre">Hotspots</span></code> with the following batch script:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#!/bin/bash</span>
<span class="cp">#SBATCH --job-name=tsunami</span>
<span class="cp">#SBATCH --output=tsunami.out</span>
<span class="cp">#SBATCH --error=tsunami.err</span>
<span class="cp">#SBATCH --partition=s_hadoop</span>
<span class="cp">#SBATCH --nodes=1</span>
<span class="cp">#SBATCH --ntasks=1</span>
<span class="cp">#SBATCH --time=10:00:00</span>
<span class="cp">#SBATCH --cpus-per-task=72</span>

<span class="cp"># Load necessary modules</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">tools</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="mf">3.8</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">compiler</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">11.2.0</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">compiler</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="n">Update2</span>
<span class="n">python3</span><span class="mf">.8</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">scons</span>

<span class="n">date</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">beegfs</span><span class="o">/</span><span class="n">ri26lit</span><span class="o">/</span><span class="n">tsunami_lab</span>
<span class="n">scons</span><span class="w"> </span><span class="n">CXX</span><span class="o">=</span><span class="n">icpc</span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">hotspots</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">tsunami_lab</span><span class="w"> </span><span class="n">chile_10000m</span><span class="p">.</span><span class="n">json</span>
</pre></div>
</div>
<p>And then we looked into <code class="code docutils literal notranslate"><span class="pre">Threading</span></code> (same code, only last line has changed):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#!/bin/bash</span>
<span class="cp">#SBATCH --job-name=tsunami</span>
<span class="cp">#SBATCH --output=tsunami.out</span>
<span class="cp">#SBATCH --error=tsunami.err</span>
<span class="cp">#SBATCH --partition=s_hadoop</span>
<span class="cp">#SBATCH --nodes=1</span>
<span class="cp">#SBATCH --ntasks=1</span>
<span class="cp">#SBATCH --time=10:00:00</span>
<span class="cp">#SBATCH --cpus-per-task=72</span>

<span class="cp"># Load necessary modules</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">tools</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="mf">3.8</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">compiler</span><span class="o">/</span><span class="n">gcc</span><span class="o">/</span><span class="mf">11.2.0</span>
<span class="k">module</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="n">compiler</span><span class="o">/</span><span class="n">intel</span><span class="o">/</span><span class="mi">2020</span><span class="o">-</span><span class="n">Update2</span>
<span class="n">python3</span><span class="mf">.8</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">scons</span>

<span class="n">date</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">beegfs</span><span class="o">/</span><span class="n">ri26lit</span><span class="o">/</span><span class="n">tsunami_lab</span>
<span class="n">scons</span><span class="w"> </span><span class="n">CXX</span><span class="o">=</span><span class="n">icpc</span>
<span class="n">vtune</span><span class="w"> </span><span class="o">-</span><span class="n">collect</span><span class="w"> </span><span class="n">threading</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">tsunami_lab</span><span class="w"> </span><span class="n">chile_10000m</span><span class="p">.</span><span class="n">json</span>
</pre></div>
</div>
<p>The results in the Intel Vtune Profiler GUI for chile_10000m showed that a lot of CPU time is used for the <code class="code docutils literal notranslate"><span class="pre">nc_get_var_float</span></code> in our netCDF reader.
We already knew that we might have overused <code class="code docutils literal notranslate"><span class="pre">nc_get_var_float</span></code>, but we did not expect it to be so dominant.</p>
<a class="reference internal image-reference" href="../_images/chile_10000m.png"><img alt="../_images/chile_10000m.png" src="../_images/chile_10000m.png" style="width: 400px;" /></a>
<p>Suspecting that there were other obvious bottlenecks, we ran chile again, but this time with a grid size of 1000m.</p>
<p>As expected, this time Wavepropagation2d clearly stood out with about 35% of the CPU time.
NetUpdates and WaveSpeeds required roughly the same amount of CPU time as in the simulation above and therefore took second and third place.</p>
<a class="reference internal image-reference" href="../_images/chile_1000m1.png"><img alt="../_images/chile_1000m1.png" src="../_images/chile_1000m1.png" style="width: 400px;" /></a>
</section>
<section id="individual-phase">
<h2><span class="section-number">9.4. </span>Individual Phase<a class="headerlink" href="#individual-phase" title="Link to this heading"></a></h2>
<p>For our individual phase, we would like to try to optimize our solver by dividing our mesh into several smaller meshes. These smaller meshes can be simulated simultaneously on different cores to calculate the net updates faster. The challenge is to update the intersections of these smaller meshes at each time step.</p>
<p>We hope that by parallelizing our computations, we can gain a lot of computing power. We also hope to deepen our understanding of good parallelization practices.</p>
<p>As a second option, we would like to improve our solver by implementing adaptive mesh refinement to improve the resolution in areas of interest. For this we can use the paper <em>Adaptive Mesh Refinement Using Wave-Propagation Algorithms for Hyperbolic Systems</em> by Marsha J. Berger and Randall J. LeVeque.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="assignment_7.html" class="btn btn-neutral float-left" title="8. Week Report 7" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="assignment_9.html" class="btn btn-neutral float-right" title="10. Weekly Report 9" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Bohdan Babii, Phillip Rothenbeck, Moritz Rätz, Marek Sommerfeld.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>